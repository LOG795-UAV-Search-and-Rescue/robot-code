<!DOCTYPE html>
<html>

<head>
    <title>Dynamic Graph</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            height: 100vh;
        }

        h2 {
            text-align: center;
        }

        canvas {
            border: 1px solid #ccc;
            margin: 20px auto;
            width: 100%;
            height: 100%;
        }

        .container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            grid-template-rows: repeat(2, 1fr);
            grid-column-gap: 0px;
            grid-row-gap: 0px;
            height: 100%;
        }

        .pose_container {
            grid-area: 1 / 1 / 2 / 2;
        }

        .odom_container {
            grid-area: 1 / 2 / 2 / 3;
        }

        .angle_container {
            grid-area: 2 / 1 / 3 / 2;
        }

        .accel_container {
            grid-area: 2 / 2 / 3 / 3;
        }
    </style>
</head>

<body>
    <h1>UGV Real-Time Graphs</h1>
    <div>
        <button style="padding-right: 3px;" onclick="downloadCsv()">Download Data</button>
        <button style="padding-right: 3px;" onclick="stopMoving()">Stop</button>
        <input type="text" id="go_to_x" placeholder="X coordinate">
        <span>, </span>
        <input type="text" id="go_to_y" placeholder="Y coordinate">
        <button style="padding-right: 3px;" onclick="sendGoTo()">Go To</button>
        <input type="text" id="turn" placeholder="Turn Angle (deg)">
        <button style="padding-right: 3px;" onclick="sendTurn()">Turn</button>
    </div>

    <div class="container">
        <div class="pose_container">
            <h3 id="pose-h" style="text-align: center;">Position</h3>
            <div style="display: flex; align-content: center; width: 450px; height: 450px;"><canvas id="pose"></canvas></div>
        </div>

        <div class="odom_container">
            <h3 style="text-align: center;">Odometry (distance travelled)</h3>
            <canvas id="odometry"></canvas>
        </div>

        <div class="angle_container">
            <h3 style="text-align: center;">Angle Velocity</h3>
            <canvas id="angle"></canvas>
        </div>

        <div class="accel_container">
            <h3 style="text-align: center;">Acceleration</h3>
            <canvas id="accel"></canvas>
        </div>
    </div>
    <script>
        function radToDeg(rad) {
            return rad * (180 / Math.PI);
        }

        function downloadCsv() {
            fetchData().then(data => {
                let csvData = "Time (s),x (m),y (m),yaw (deg),Left Wheel (m),Right Wheel (m),gx (deg/s),gy (deg/s),gz (deg/s),mx,my,mz,ax (m/s^2),ay (m/s^2),az (m/s^2)\n";

                data.kpi.forEach(d => {
                    csvData += `${d.t},${d.x},${d.y},${radToDeg(d.yaw)},${d.odl},${d.odr},${d.gx},${d.gy},${d.gz},${d.mx},${d.my},${d.mz},${d.ax},${d.ay},${d.az}\n`;
                });

                const blob = new Blob([csvData], { type: "text/csv;charset=utf-8;" });
                const link = document.createElement("a");
                const timestamp = new Date().toISOString().replace(/[:.-]/g, "_");

                link.download = `data-${timestamp}.csv`;
                link.href = URL.createObjectURL(blob);

                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(link.href);
            });
        }

        function sendGoTo() {
            const x = parseFloat(document.getElementById('go_to_x').value);
            const y = parseFloat(document.getElementById('go_to_y').value);
            fetch('/go_to', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ x: x, y: y }),
            });
        }

        function sendTurn() {
            const angleDeg = parseFloat(document.getElementById('turn').value);
            fetch('/turn_to', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ angle: angleDeg }),
            });
        }

        function stopMoving() {
            fetch('/stop', {
                method: 'POST',
            });
        }

        var x = 0;
        var y = 0;
        var yaw = 0;
        var go_to_x = 0;
        var go_to_y = 0;
        const pose_canvas = document.getElementById('pose');
        const pose_ctx = pose_canvas.getContext('2d');
        const pose_h = document.getElementById('pose-h');
        const odometry_ctx = document.getElementById('odometry').getContext('2d');
        const angle_ctx = document.getElementById('angle').getContext('2d');
        const accel_ctx = document.getElementById('accel').getContext('2d');

        // Update your charts here using the kpi_data
        const pose_chart = new Chart(pose_ctx, {
            type: 'line',
            data: {
                datasets: [
                    {
                        label: 'Position',
                        borderColor: 'blue',
                        pointBackgroundColor: 'blue',
                        pointRadius: 2,
                        borderWidth: 2,
                        fill: false,
                        data: []
                    },
                    {
                        label: 'Direction',
                        borderColor: 'red',
                        pointRadius: 0,
                        borderWidth: 2,
                        fill: false,
                        data: []
                    },
                    {
                        label: 'Go to Points',
                        borderColor: 'green',
                        pointBackgroundColor: 'green',
                        pointRadius: 1,
                        borderWidth: 1,
                        fill: false,
                        data: []
                    }
                ]
            },
            options: {
                maintainAspectRatio: true,
                aspectRatio: 1,
                scales: {
                    x: { type: 'linear', min: -5, max: 5, position: 'bottom', title: { display: true, text: 'x (m)' }, ticks: { count: 11 } },
                    y: { min: -5, max: 5, title: { display: true, text: 'y (m)' }, ticks: { count: 11 }}
                }
            }
        });

        // Update your charts here using the kpi_data
        const odom_chart = new Chart(odometry_ctx, {
            type: 'line',
            data: {
                datasets: [
                    {
                        label: 'Right Wheel',
                        borderColor: 'blue',
                        pointRadius: 0,
                        fill: false,
                        data: []
                    },
                    {
                        label: 'Left Wheel',
                        borderColor: 'red',
                        pointRadius: 0,
                        fill: false,
                        data: []
                    }
                ]
            },
            options: {
                scales: {
                    x: { type: 'linear', position: 'bottom', title: { display: true, text: 'Time (s)' } },
                    y: { title: { display: true, text: 'Distance (m)' } }
                }
            }
        });

        // Update your charts here using the kpi_data
        const angle_chart = new Chart(angle_ctx, {
            type: 'line',
            data: {
                datasets: [
                    {
                        label: 'Angle Velocity (yaw)',
                        borderColor: 'blue',
                        pointRadius: 0,
                        fill: true,
                        data: []
                    },
                ]
            },
            options: {
                scales: {
                    x: { type: 'linear', position: 'bottom', title: { display: true, text: 'Time (s)' } },
                    y: { title: { display: true, text: 'Velocity (rad/s)' } }
                }
            }
        });

        // Update your charts here using the kpi_data
        const accel_chart = new Chart(accel_ctx, {
            type: 'line',
            data: {
                datasets: [
                    {
                        label: 'ax',
                        borderColor: 'blue',
                        pointRadius: 0,
                        borderWidth: 1,
                        fill: true,
                        data: []
                    },
                    {
                        label: 'ay',
                        borderColor: 'red',
                        pointRadius: 0,
                        borderWidth: 1,
                        fill: true,
                        data: []
                    },
                    {
                        label: 'az',
                        borderColor: 'green',
                        pointRadius: 0,
                        borderWidth: 1,
                        fill: true,
                        data: []
                    }
                ]
            },
            options: {
                scales: {
                    x: { type: 'linear', position: 'bottom', title: { display: true, text: 'Time (s)' } },
                    y: { title: { display: true, text: 'Acceleration (m/s^2)' } }
                }
            }
        });

        function fetchData(n = 0) {
            if (n)
                return fetch('/get_kpi?n=' + (n))
                    .then(response => response.json());

            return fetch('/get_kpi')
                .then(response => response.json());
        }

        function updateCharts(data) {
            pose_chart.data.datasets[0].data = [{ x: data.x, y: data.y }];
            pose_chart.data.datasets[1].data = [{ x: data.x, y: data.y }, { x: data.x + (0.5 * Math.cos(data.yaw)), y: data.y + (0.5 * Math.sin(data.yaw)) }];
            if (pose_chart.data.datasets[2].data.length > 0)
                pose_chart.data.datasets[2].data = [{ x: data.x, y: data.y }, pose_chart.data.datasets[2].data[0]];

            pose_chart.update();
            pose_h.innerText = `Position (x: ${data.x.toFixed(2)} m, y: ${data.y.toFixed(2)} m, yaw: ${radToDeg(data.yaw).toFixed(2)}Â°)`;

            const kpi_data = data.kpi;
            odom_chart.data.datasets[0].data = kpi_data.map(d => ({ x: (d.t), y: d.odr }));
            odom_chart.data.datasets[1].data = kpi_data.map(d => ({ x: (d.t), y: d.odl }));
            odom_chart.update();

            angle_chart.data.datasets[0].data = kpi_data.map(d => ({ x: (d.t), y: d.gz }));
            angle_chart.update();

            accel_chart.data.datasets[0].data = kpi_data.map(d => ({ x: (d.t), y: d.ax }));
            accel_chart.data.datasets[1].data = kpi_data.map(d => ({ x: (d.t), y: d.ay }));
            accel_chart.data.datasets[2].data = kpi_data.map(d => ({ x: (d.t), y: d.az }));
            accel_chart.update();
        }

        async function tick() {
            const data = await fetchData(300);
            console.log(data);
            updateCharts(data);
            // Update charts with kpi_data
            setTimeout(tick, 200); // Fetch new data every second
        }

        pose_canvas.onclick = (event) => {
            // Get the relative position of the click on the canvas
            const canvasPosition = Chart.helpers.getRelativePosition(event, pose_chart);

            // Convert pixel coordinates to data values
            // Substitute 'x' and 'y' with your actual scale IDs if different
            const dataX = pose_chart.scales.x.getValueForPixel(canvasPosition.x);
            const dataY = pose_chart.scales.y.getValueForPixel(canvasPosition.y);

            // Add the new point to the dataset
            pose_chart.data.datasets[2].data = [{ x: dataX, y: dataY }];

            fetch('/go_to', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ x: dataX, y: dataY }),
            });

            // Update the chart to display the new point
            pose_chart.update();
        };

        tick();
    </script>
</body>

</html>